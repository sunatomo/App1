<html>
    <body>
        <input id='hu'>
		<canvas id='c1' width='100' height='100'>
		</canvas>
		<br>
	    <button>検索</button>
	</body>
	<head>
		<script src='login.js'></script>
		<script src='http://hammerjs.github.io/dist/hammer.min.js'></script>
		<script>
            var shops = [
                {
                    name: 'test1',
                    price: 50000000,
                    location: {x:0, y:0}
                },
                {
                    name: 'test2',
                    price: 5,
                    location: {x:200, y:200}
                }
            ]
		    var img = new Image();
			img.src = "map.png";
			var canvas = document.getElementById('c1');
            var hammerObj = new Hammer(canvas);
            hammerObj.get("pan").set({ enable: true });
            hammerObj.get("pinch").set({ enable: true });
            hammerObj.get("tap").set({ enable: true });
            
            var rotateX = 0;
            var rotateY = 0.1;
            hammerObj.on("pan",function (e) {
                //console.info(e);
                rotateX += e.velocityX/10;
                rotateY += e.velocityY/10;
                if(rotateY>1.5) rotateY=1.5;
                if(rotateY<0.1) rotateY=0.1;
				draw(rotateX,rotateY);
            }); 
            var start_scale = 10000.0;
            hammerObj.on("pinch",function (e) {
                console.info(e);
                if(e.isFirst) {
                    start_scale = scale;
                }
                scale = start_scale * e.scale;
                document.getElementById('hu').value = e.scale;
                if(e.isFinal) {
                    start_scale = scale;
                }
				draw(rotateX,rotateY);
            }); 
            
			var ctx = canvas.getContext('2d');
			window.onresize = function() {
				canvas.width = window.innerWidth;
				canvas.height = window.innerHeight;
				draw(rotateX,rotateY);
			}
			img.onload = function () {
				window.onresize();
			}
            var scale = 10000;
			function getRotateMatrix3D(y,x) {
			    var sinX = Math.sin(x);
			    var cosX = Math.cos(x);
			    var sinY = Math.sin(y);
			    var cosY = Math.cos(y);
			    return [
				    [cosY, 0 , sinY],
				    [sinY*sinX , cosX, -sinX*cosY],
				    [-sinY*cosX, sinX, cosY*cosX]
				];
			}
			function getPoint2D(m, x,y,z) {
			    var X = m[0][0]*x + m[0][1]*y + m[0][2]*z;
			    var Y = m[1][0]*x + m[1][1]*y + m[1][2]*z;
			    var Z = m[2][0]*x + m[2][1]*y + m[2][2]*z + img.height+img.width + 1;
				return [X*scale/Z+window.innerWidth/2, Y*scale/Z+window.innerHeight/2, Z];
			}
			function draw(x,y) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
				ctx.save();
				ctx.beginPath();
				var m3 = getRotateMatrix3D(x,y);
				var p1 = getPoint2D(m3,-img.width/2,10,img.height/2);
				var p2 = getPoint2D(m3,img.width/2,10,img.height/2);
				var p3 = getPoint2D(m3,-img.width/2,10,-img.height/2);
				var p4 = getPoint2D(m3,img.width/2,10,-img.height/2);
                
				ctx.moveTo(p1[0],p1[1]);
				ctx.lineTo(p2[0],p2[1]);
				ctx.lineTo(p3[0],p3[1]);
				ctx.closePath();
				ctx.clip();
				ctx.setTransform((p2[0]-p1[0])/img.width,(p2[1]-p1[1])/img.width,(p3[0]-p1[0])/img.height,(p3[1]-p1[1])/img.height,p1[0],p1[1]);
				ctx.drawImage(img, 0, 0);
                ctx.restore();
                
                ctx.save();
				ctx.beginPath();
				ctx.moveTo(p4[0],p4[1]);
				ctx.lineTo(p2[0],p2[1]);
				ctx.lineTo(p3[0],p3[1]);
				ctx.closePath();
				ctx.clip();
				ctx.setTransform((p4[0]-p3[0])/img.width,(p4[1]-p3[1])/img.width,-(p2[0]-p4[0])/img.height,-(p2[1]-p4[1])/img.height,p3[0],p3[1]);
				ctx.drawImage(img, 0, -img.height);
				ctx.restore();
                
                for(var s of shops) {
                    s.tranlated = getPoint2D(m3, s.location.x,5 , s.location.y);
                }
                ctx.font = "italic bold 40px 'HG正楷書体-PRO'";
                for(var s of shops.sort(function (a,b) {return b.tranlated[2]-a.tranlated[2];}) ) {
                    ctx.fillStyle = 'rgb(80, 192, 77)';
                    ctx.fillRect(s.tranlated[0], s.tranlated[1]-50, Math.max(s.name.length, (""+s.price).length) *40, 110);
                    
                    ctx.fillStyle = 'rgb(0, 0, 0)';
                    ctx.fillText(s.name, s.tranlated[0], s.tranlated[1]);
                    ctx.fillText(''+s.price, s.tranlated[0], s.tranlated[1]+50);
                }
			}
            window.onwheel = function(e) {
                scale +=e.wheelDelta;
                return false;
            }
		</script>
	</head>
</html>
